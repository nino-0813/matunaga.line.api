# LINEボット接続手順

このAPIをLINEボットとして接続するための完全ガイドです。

## 📋 前提条件

- ✅ APIがデプロイされている（Render、Heroku、VPSなど）
- ✅ デプロイ先のURLが分かっている
- ✅ LINE Developersアカウントを持っている

---

## 🚀 ステップ1: LINE Developers Consoleでチャネルを作成

### 1-1. LINE Developersにアクセス
1. [LINE Developers Console](https://developers.line.biz/console/)にアクセス
2. LINEアカウントでログイン

### 1-2. プロバイダーを作成（初回のみ）
1. 「プロバイダー」をクリック
2. 「新規作成」をクリック
3. プロバイダー名を入力（例：「二の腕エステサロン」）
4. 「作成」をクリック

### 1-3. Messaging APIチャネルを作成
1. 作成したプロバイダーを選択
2. 「チャネル」タブをクリック
3. 「新規チャネル作成」→「Messaging API」を選択
4. チャネル情報を入力：
   - **チャネル名**: 例「二の腕エステサロン Bot」
   - **チャネル説明**: 任意
   - **カテゴリー**: 「美容・健康」など
   - **サブカテゴリー**: 適切なものを選択
5. 利用規約に同意して「作成」をクリック

---

## 🔑 ステップ2: チャネルアクセストークンとシークレットを取得

### 2-1. チャネルアクセストークンを取得
1. 作成したチャネルを選択
2. 「Messaging API設定」タブを開く
3. 「チャネルアクセストークン」セクションまでスクロール
4. 「発行」または「再発行」をクリック
5. **トークンをコピー**（後で使います）
   - ⚠️ このトークンは一度しか表示されません。必ずコピーしてください！

### 2-2. チャネルシークレットを確認
1. 「基本設定」タブを開く
2. 「チャネルシークレット」をコピー（後で使います）

---

## 🌐 ステップ3: Webhook URLを設定

### 3-1. デプロイ先のURLを確認
あなたのAPIがデプロイされているURLを確認してください。

**例：**
- Render: `https://matunaga-ai-api-1.onrender.com`
- Heroku: `https://your-app-name.herokuapp.com`
- その他: `https://your-domain.com`

### 3-2. Webhook URLを設定
1. LINE Developers Consoleで、作成したチャネルを選択
2. 「Messaging API設定」タブを開く
3. 「Webhook URL」セクションまでスクロール
4. 「Webhook URL」欄に以下を入力：
   ```
   https://あなたのドメイン/callback
   ```
   **例：**
   ```
   https://matunaga-ai-api-1.onrender.com/callback
   ```
   ⚠️ 必ず `/callback` で終わるようにしてください！

### 3-3. Webhook URLを検証
1. **まず、サービスが起動していることを確認**
   - ブラウザで `https://あなたのドメイン/` にアクセス
   - 「{"status": "ok", "message": "LINE Bot is running"}」と表示されればOK
   - 無料プラン（Renderなど）の場合、スリープから復帰するまで30秒〜1分かかることがあります

2. 「検証」ボタンをクリック
   - ✅ **成功**: 「Webhook URLの検証に成功しました」と表示
   - ❌ **失敗**: エラーメッセージを確認（後述のトラブルシューティングを参照）

### 3-4. Webhookの利用を有効化
1. 「Webhookの利用」を「利用する」に変更
2. 「応答メッセージ」を「無効」に変更
   - ⚠️ 重要：AIが応答するため、LINEの自動応答は無効にします

---

## ⚙️ ステップ4: 環境変数を設定

### 4-1. デプロイ先で環境変数を設定

#### Renderの場合
1. Renderダッシュボードでサービスを選択
2. 「Environment」タブを開く
3. 以下の環境変数を追加：

| 環境変数名 | 値 |
|----------|-----|
| `LINE_CHANNEL_ACCESS_TOKEN` | ステップ2-1で取得したトークン |
| `LINE_CHANNEL_SECRET` | ステップ2-2で取得したシークレット |
| `OPENAI_API_KEY` | OpenAI APIキー |
| `PORT` | `8080`（Renderの場合は自動設定される場合あり） |

4. 「Save Changes」をクリック
5. サービスが再起動されるのを待つ

#### Herokuの場合
```bash
heroku config:set LINE_CHANNEL_ACCESS_TOKEN=your_token
heroku config:set LINE_CHANNEL_SECRET=your_secret
heroku config:set OPENAI_API_KEY=your_key
heroku config:set PORT=8080
```

#### その他の場合
デプロイ先の環境変数設定方法に従って、上記の環境変数を設定してください。

---

## ✅ ステップ5: 動作確認

### 5-1. Botに友達追加
1. LINE Developers Consoleで「Messaging API設定」タブを開く
2. 「QRコード」を表示
3. スマートフォンのLINEアプリでQRコードをスキャン
4. Botを友達追加

### 5-2. メッセージを送信してテスト
1. LINEアプリでBotにメッセージを送信（例：「二の腕が気になる」）
2. AIが応答することを確認
3. 初期挨拶が表示され、選択肢が提示されることを確認

### 5-3. Webhook送信の確認
1. LINE Developers Consoleの「Messaging API設定」タブで
2. 「Webhook送信」の回数が増えていることを確認
   - メッセージを送信するたびに数値が増えれば正常です

---

## 🐛 トラブルシューティング

### ❌ Webhook URLの検証が失敗する

**原因1: サービスがスリープしている**
- **解決策**: ブラウザでサービスURLにアクセスしてから、再度検証を試す
- 無料プラン（Renderなど）では、15分間アクセスがないとスリープします

**原因2: URLが間違っている**
- **確認**: URLの最後に `/callback` が付いているか
- **確認**: `https://` で始まっているか（`http://` は不可）
- **確認**: スペースや余分な文字が入っていないか

**原因3: ポートが間違っている**
- **確認**: アプリケーションが正しいポートで起動しているか
- Renderの場合、`PORT`環境変数は通常不要（自動設定）

### ❌ メッセージを送っても応答がない

**原因1: 環境変数が設定されていない**
- **確認**: `LINE_CHANNEL_ACCESS_TOKEN` が設定されているか
- **確認**: `LINE_CHANNEL_SECRET` が設定されているか
- **確認**: `OPENAI_API_KEY` が設定されているか

**原因2: 「応答メッセージ」が有効になっている**
- **解決策**: LINE Developers Consoleで「応答メッセージ」を「無効」に設定

**原因3: Webhookの利用が無効になっている**
- **確認**: 「Webhookの利用」が「利用する」になっているか

**原因4: ログにエラーが出ている**
- **確認**: デプロイ先のログを確認
- エラーメッセージがあれば、それを解決する

### ❌ OpenAI APIエラー

**原因1: APIキーが間違っている**
- **確認**: `OPENAI_API_KEY` が正しく設定されているか
- **確認**: APIキーに余分なスペースが入っていないか

**原因2: クレジット残高が不足している**
- **確認**: OpenAI Platformでクレジット残高を確認

---

## 📝 チェックリスト

接続が完了したら、以下を確認してください：

- [ ] LINE Developers Consoleでチャネルを作成した
- [ ] チャネルアクセストークンを取得した
- [ ] チャネルシークレットを取得した
- [ ] Webhook URLを設定した（`/callback`で終わる）
- [ ] Webhook URLの検証が成功した
- [ ] 「Webhookの利用」を「利用する」に設定した
- [ ] 「応答メッセージ」を「無効」に設定した
- [ ] 環境変数をすべて設定した
- [ ] Botに友達追加した
- [ ] メッセージを送信して応答を確認した

---

## 🎉 完了！

これで、LINEボットとしてAPIが動作するようになりました！

何か問題があれば、上記のトラブルシューティングを参照してください。

