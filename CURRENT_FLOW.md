# LINEボットの現在の回答フロー

## 会話の流れ（全体像）

### 1. 初回メッセージ（新規ユーザー）

1. **ユーザーがメッセージを送信**
   - 例：「二の腕が気になる」「二の腕を細くしたい」

2. **初期挨拶を送信**
   ```
   こんにちは！二の腕専門のエステサロンです。
   
   二の腕で気になること、なんでもお聞かせください。
   あなたにぴったりのアドバイスをさせていただきますね！😊
   ```

3. **ユーザーの質問にAIが回答**
   - 二の腕専門のプロとして、質問に答える
   - 2〜4行の簡潔な回答
   - やさしく、専門的で実践的な内容

4. **2つの選択肢を提示（AIが動的に生成）**
   - 会話の流れに合わせて、ユーザーが次に聞きたくなるような2つの質問を生成
   - 例：「どんな時に気になりますか？」「どんな方法を試しましたか？」
   - 各選択肢は20文字以内
   - 会話回数カウント：1回目

---

### 2. 2回目〜4回目の会話

1. **ユーザーが選択肢を選択または質問を送信**
   - 選択肢から選ぶ、または自由に質問

2. **AIが回答**
   - ユーザーの質問や選択した内容に答える
   - 二の腕専門の視点から的確にアドバイス

3. **2つの選択肢を提示（AIが動的に生成）**
   - 会話の流れに合わせて新しい選択肢を生成
   - 会話回数カウント：2回目、3回目、4回目

---

### 3. 5回目（4回の会話終了後）

1. **ユーザーが最後の選択肢を選択または質問を送信**

2. **最終メッセージを送信**
   ```
   お話を聞かせていただき、ありがとうございました！
   
   あなたの状況がよくわかりました。
   次はどうしますか？
   ```

3. **最終選択肢を提示**
   - 「今すぐできるアドバイスが欲しい」
   - 「プロに相談・予約したい」

---

### 4. 最終選択肢の処理

#### A. 「今すぐできるアドバイスが欲しい」を選択した場合

1. **会話履歴を元にアドバイスを生成**
   - これまでの4回の会話で収集した情報を元に
   - 今すぐできる具体的で実践的なアドバイスを2〜4行で提示
   - 専門的で実践的な内容

2. **会話をリセット**
   - 新しい会話を開始できるように状態をクリア

#### B. 「プロに相談・予約したい」を選択した場合

1. **予約案内メッセージを送信**
   ```
   ありがとうございます！
   
   リッチメニューから「予約を申し込む」をタップしていただくか、
   このまま「予約したい」とメッセージをお送りください。
   
   担当者がご対応させていただきます。😊
   ```

2. **会話をリセット**
   - 新しい会話を開始できるように状態をクリア

---

## AIの回答スタイル

### プロンプトの特徴

- **役割**: 二の腕の悩みを10年以上見てきたエステのプロフェッショナル
- **話し方**: 
  - 1回の返信は2〜4行まで
  - 専門用語は使わず、わかりやすい言葉で
  - やさしく、安心感のある口調
  - 友達すぎず、先生すぎない距離感

- **回答の流れ**:
  1. ユーザーの質問や悩みに答える（具体的に）
  2. 二の腕専門の視点から的確なアドバイスを一言
  3. 回答の最後に、次のステップにつながる自然な言葉で終わる

- **禁止事項**:
  - 長文説明
  - 医療的な断定（「治る」など）
  - 過度な効果保証（「必ず」など）
  - 押し売り表現（「ぜひ」「絶対」など）
  - 一般的すぎる回答

---

## 選択肢の生成

### 動的生成

- AIが会話の流れを分析して、ユーザーが次に興味を持ちそうな2つの質問を生成
- 会話履歴の直近6件を参照
- 二の腕に関連する内容
- 各選択肢は20文字以内に制限

### 例

- 1回目: 「どんな時に気になりますか？」「どんな方法を試しましたか？」
- 2回目: 「理想の二の腕はどんな感じですか？」「どのくらい前から気になり始めましたか？」
- 3回目: 「日常生活で困っていることは？」「エステに興味はありますか？」
- 4回目: 「他の部分も気になりますか？」「サロンでのケアについて聞きたい」

---

## 会話のリセット

以下の場合に会話がリセットされます：

1. 「今すぐできるアドバイスが欲しい」を選択した後
2. 「プロに相談・予約したい」を選択した後

リセット後は、新しい会話として最初から開始できます。

---

## 技術的な詳細

- **会話履歴**: メモリに保存（最新30件まで保持）
- **会話回数カウント**: ユーザーごとに管理
- **エラーハンドリング**: 選択肢生成に失敗した場合は、デフォルトの選択肢を使用

